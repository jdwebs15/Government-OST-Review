<script>
/* =========================================================
   LEGEND ARCADE SCRIPT (bells + whistles)
   Requires these elements in your HTML:
   - #question, #choices, #xp, #level, #streak, #badge
   - #progress (inner bar div)
   - #ticket
   - canvas#confetti
   - div#popLayer
   - a container with class ".card" (for screen shake)
   ========================================================= */

// =========================
// SOUND EFFECTS (synced)
// =========================
const SFX = {
  correct: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"),
  wrong: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"),
  level: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-game-level-completed-2059.mp3"),
  boom: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-2759.mp3"),
  sparkle: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1936.mp3"),
  tick: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3")
};
Object.values(SFX).forEach(a => { a.preload = "auto"; a.volume = 0.65; });
SFX.boom.volume = 0.55;
SFX.sparkle.volume = 0.60;
SFX.tick.volume = 0.35;

// clone-play helper (so bursts can overlap)
function playSfx(audio){
  try{
    const a = audio.cloneNode();
    a.volume = audio.volume;
    a.play().catch(()=>{});
  }catch(e){}
}

// Try to unlock audio on first user gesture (helps on iOS / strict browsers)
let audioUnlocked = false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  Object.values(SFX).forEach(a=>{
    try{
      const b = a.cloneNode();
      b.volume = 0;
      b.play().then(()=>b.pause()).catch(()=>{});
    }catch(e){}
  });
}
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });

// =========================
// QUESTIONS (demo set)
// =========================
const questions=[
  {q:"Why was the 1851 Ohio Constitution adopted?",a:["To limit legislative power and state debt","To expand slavery","To eliminate courts"],c:0},
  {q:"What reform made judges more accountable in 1851?",a:["Election of judges","Lifetime appointment","Executive selection only"],c:0},
  {q:"Which feature exists in Ohio but not U.S. Constitution?",a:["Initiative and referendum","Bill of Rights","Three branches"],c:0},
  {q:"Initiative allows citizens to‚Ä¶",a:["Propose laws by petition","Appoint judges","Impeach governor"],c:0},
  {q:"Referendum allows citizens to‚Ä¶",a:["Vote on laws passed by legislature","Rewrite federal laws","Control Supreme Court"],c:0},
  {q:"One problem under the 1803 Constitution was‚Ä¶",a:["Legislative dominance","Too many judges","No governor"],c:0},
  {q:"Both Ohio and U.S. Constitutions include‚Ä¶",a:["Separation of powers","Monarchy","Direct democracy only"],c:0},
  {q:"Debt limits were added in 1851 to‚Ä¶",a:["Protect taxpayers","Increase federal control","Expand war spending"],c:0},
  {q:"Attending a school board meeting demonstrates‚Ä¶",a:["Civic responsibility","Judicial review","Military authority"],c:0}
];

// =========================
// STATE
// =========================
let index=0;
let xp=0;
let level=1;
let streak=0;
let bestStreak=0;
let answered=false;
let selectedIdx=null;

let name="";               // optional: if you add a name input, set it
let startTime=new Date();

// =========================
// DOM
// =========================
const qDiv=document.getElementById("question");
const cDiv=document.getElementById("choices");
const xpEl=document.getElementById("xp");
const lvlEl=document.getElementById("level");
const streakEl=document.getElementById("streak");
const badgeEl=document.getElementById("badge");
const cardEl=document.querySelector(".card");
const popLayer=document.getElementById("popLayer");

const progressBar=document.getElementById("progress");
const ticketEl=document.getElementById("ticket");

// =========================
// FX HELPERS
// =========================
function triggerShake(intensity=1){
  // intensity can scale shake duration slightly via CSS class
  cardEl.classList.remove("shake");
  void cardEl.offsetWidth;
  cardEl.classList.add("shake");
}

function glowXP(){
  xpEl.classList.remove("xpGlow");
  void xpEl.offsetWidth;
  xpEl.classList.add("xpGlow");
}

function popup(text, anchorEl){
  if(!popLayer || !anchorEl) return;
  const r = anchorEl.getBoundingClientRect();
  const p = document.createElement("div");
  p.className = "popup";
  p.textContent = text;
  p.style.left = (r.left + r.width/2) + "px";
  p.style.top = (r.top - 6) + "px";
  popLayer.appendChild(p);
  setTimeout(()=> p.remove(), 1000);
}

function badgeUnlock(newText){
  badgeEl.textContent = newText;
  badgeEl.classList.remove("badgeUnlock");
  void badgeEl.offsetWidth;
  badgeEl.classList.add("badgeUnlock");
  playSfx(SFX.sparkle);
  // small fireworks pop on badge unlock
  fireworkBurst(canvas.width/2, canvas.height*0.22, 2.2);
}

function setProgress(){
  // show answered progress (question index completed)
  const pct = Math.round((index / questions.length) * 100);
  if(progressBar) progressBar.style.width = pct + "%";
}

// =========================
// RENDER (with click-select + submit)
// =========================
function render(){
  const q=questions[index];
  answered=false;
  selectedIdx=null;

  qDiv.innerHTML = `
    <h3 style="margin:0 0 6px">Question ${index+1} / ${questions.length}</h3>
    <div style="opacity:.92">${q.q}</div>
  `;

  cDiv.innerHTML="";
  q.a.forEach((choice,i)=>{
    const div=document.createElement("div");
    div.className="choice";
    div.textContent=choice;

    div.addEventListener("click", ()=>{
      if(answered) return;
      playSfx(SFX.tick);
      selectedIdx = i;
      [...cDiv.querySelectorAll(".choice")].forEach(x=>x.classList.remove("sel"));
      div.classList.add("sel");
    });

    cDiv.appendChild(div);
  });

  setProgress();
}

function updateStats(){
  xpEl.textContent=xp;
  lvlEl.textContent=level;
  streakEl.textContent=streak;
}

// =========================
// SUBMIT & NEXT
// =========================
function submit(){
  if(answered) return;
  if(selectedIdx===null){
    popup("Pick an answer!", lvlEl);
    triggerShake();
    playSfx(SFX.wrong);
    return;
  }

  const q = questions[index];
  const correct = (selectedIdx === q.c);

  // mark choices
  const choicesEls = [...cDiv.querySelectorAll(".choice")];
  choicesEls.forEach((el,i)=>{
    el.style.pointerEvents="none";
    if(i === q.c) el.classList.add("correct");
    if(i === selectedIdx && i !== q.c) el.classList.add("wrong");
  });

  answered = true;

  if(correct){
    playSfx(SFX.correct);

    const gain = 10 + (streak*2);
    xp += gain;
    streak++;
    if(streak > bestStreak) bestStreak = streak;

    glowXP();
    popup(`+${gain} XP`, xpEl);

    // LEVEL UP pacing
    const newLevel = 1 + Math.floor(xp / 30);
    if(newLevel > level){
      level = newLevel;
      playSfx(SFX.level);

      // animated badge ladder
      if(level >= 8) badgeUnlock("STATEHOUSE LEGEND");
      else if(level >= 6) badgeUnlock("Ohio Icon");
      else if(level >= 4) badgeUnlock("Civic Champion");
      else badgeUnlock("Reform Ranger");

      // bigger fireworks on level-up
      fireworkBurst(canvas.width/2, canvas.height*0.28, 3.3);
    }

    updateStats();

    // optional: auto-advance after short delay
    setTimeout(()=> next(), 650);

  } else {
    playSfx(SFX.wrong);
    triggerShake();

    popup("‚ùå", streakEl);
    popup("Streak broken!", streakEl);

    streak = 0;
    updateStats();
    // require manual next (prevents ‚Äúmiss + auto advance‚Äù)
  }
}

function next(){
  if(!answered){
    // force submission before moving on (feels more game-like)
    popup("Submit first!", lvlEl);
    triggerShake();
    return;
  }

  index++;

  if(index >= questions.length){
    celebrate();
    return;
  }

  render();
}

// expose for your buttons if you have them
window.submit = submit;
window.next = next;

// =========================
// CONFETTI + FIREWORKS (animated, continuous)
// =========================
const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");

let confetti = [];
let fireworks = [];
let animRunning = false;
let animStopAt = 0;

// Smooth audio sync pulses during celebration
let beatTimer = null;

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);

function startCelebrationFX(durationMs=9500){
  resizeCanvas();
  animStopAt = performance.now() + durationMs;

  // build confetti field
  confetti = [];
  const count = 240;
  for(let i=0;i<count;i++){
    confetti.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height - canvas.height,
      size: Math.random()*7+4,
      vx: Math.random()*3-1.5,
      vy: Math.random()*2+2,
      rot: Math.random()*Math.PI*2,
      vr: Math.random()*0.18-0.09,
      color: `hsl(${Math.random()*360}, 100%, 55%)`,
      shape: Math.random()<0.5 ? "rect" : "ribbon"
    });
  }

  // initial big burst (center)
  fireworkBurst(canvas.width/2, canvas.height*0.38, 4.2);

  if(!animRunning){
    animRunning = true;
    playSfx(SFX.boom); // synced start
    requestAnimationFrame(loopFX);
  }

  // confetti-synced sound pulses (subtle)
  if(beatTimer) clearInterval(beatTimer);
  beatTimer = setInterval(()=>{
    // gentle sparkle tick while celebration is active
    if(performance.now() < animStopAt){
      playSfx(SFX.sparkle);
    }else{
      clearInterval(beatTimer);
      beatTimer = null;
    }
  }, 1200);
}

function fireworkBurst(x,y,intensity=3){
  const burstCount = Math.floor(55 + intensity*18);
  for(let i=0;i<burstCount;i++){
    const ang = Math.random()*Math.PI*2;
    const spd = (Math.random()*3.0 + 2.2) * intensity;
    fireworks.push({
      x,y,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      life: 70 + Math.random()*30,
      age: 0,
      size: 1.8 + Math.random()*2.4,
      color: `hsl(${Math.random()*360}, 100%, 60%)`
    });
  }
  playSfx(SFX.boom);
}

function loopFX(t){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // confetti
  const g = 0.06;
  confetti.forEach(p=>{
    p.vy += g;
    p.x += p.vx;
    p.y += p.vy;
    p.rot += p.vr;

    if(p.x < -20) p.x = canvas.width+20;
    if(p.x > canvas.width+20) p.x = -20;

    if(p.y > canvas.height+30){
      p.y = -20;
      p.x = Math.random()*canvas.width;
      p.vy = Math.random()*2+2;
    }

    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(p.rot);
    ctx.fillStyle = p.color;

    if(p.shape === "rect"){
      ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
    } else {
      ctx.beginPath();
      ctx.moveTo(-p.size, 0);
      ctx.quadraticCurveTo(0, -p.size, p.size, 0);
      ctx.quadraticCurveTo(0, p.size, -p.size, 0);
      ctx.fill();
    }
    ctx.restore();
  });

  // fireworks particles
  fireworks = fireworks.filter(f => f.age < f.life);
  fireworks.forEach(f=>{
    f.age++;
    f.vy += 0.04;
    f.vx *= 0.99;
    f.vy *= 0.99;
    f.x += f.vx;
    f.y += f.vy;

    const alpha = Math.max(0, 1 - (f.age / f.life));
    ctx.globalAlpha = alpha;
    ctx.fillStyle = f.color;
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.size, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  });

  // showy extra bursts during celebration
  if(Math.random() < 0.045){
    fireworkBurst(
      canvas.width*(0.22 + Math.random()*0.56),
      canvas.height*(0.12 + Math.random()*0.28),
      2.0
    );
  }

  if(t < animStopAt){
    requestAnimationFrame(loopFX);
  } else {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    fireworks = [];
    confetti = [];
    animRunning = false;
  }
}

// =========================
// CELEBRATE (ticket + runtime)
// =========================
function celebrate(){
  if(progressBar) progressBar.style.width = "100%";

  // big badge + fireworks show
  badgeUnlock("STATEHOUSE LEGEND");
  startCelebrationFX(10000);

  const endTime = new Date();
  const runtimeSec = Math.max(0, Math.floor((endTime - startTime)/1000));
  const mm = String(Math.floor(runtimeSec/60)).padStart(2,"0");
  const ss = String(runtimeSec%60).padStart(2,"0");

  const studentLine = name ? `STUDENT: ${name}<br>` : "";

  ticketEl.innerHTML = `
    <div class="ticket">
      <h2>üèÜ Mastery Complete!</h2>
      ${studentLine}
      XP Earned: <b>${xp}</b><br>
      Level: <b>${level}</b><br>
      Best Streak: <b>${bestStreak}</b><br>
      Started: ${startTime}<br>
      Completed: ${endTime}<br>
      Runtime: <b>${mm}:${ss}</b>
    </div>
  `;

  // optional: small screen shake for celebration impact
  triggerShake();
}

// initial paint
resizeCanvas();
render();
updateStats();
</script>
