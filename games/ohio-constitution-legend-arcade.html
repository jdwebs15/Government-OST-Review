<script>
// =========================
// SOUND EFFECTS (synced)
// =========================
const SFX = {
  correct: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"),
  wrong: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"),
  level: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-game-level-completed-2059.mp3"),
  boom: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-2759.mp3"),
  sparkle: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1936.mp3")
};
Object.values(SFX).forEach(a => { a.preload = "auto"; a.volume = 0.65; });
SFX.boom.volume = 0.55;
SFX.sparkle.volume = 0.60;

// clone-play helper (so bursts can overlap)
function playSfx(audio){
  try{
    const a = audio.cloneNode();
    a.volume = audio.volume;
    a.play().catch(()=>{});
  }catch(e){}
}

// =========================
// QUESTIONS (same as before)
// =========================
const questions=[
  {q:"Why was the 1851 Ohio Constitution adopted?",a:["To limit legislative power and state debt","To expand slavery","To eliminate courts"],c:0},
  {q:"What reform made judges more accountable in 1851?",a:["Election of judges","Lifetime appointment","Executive selection only"],c:0},
  {q:"Which feature exists in Ohio but not U.S. Constitution?",a:["Initiative and referendum","Bill of Rights","Three branches"],c:0},
  {q:"Initiative allows citizens to‚Ä¶",a:["Propose laws by petition","Appoint judges","Impeach governor"],c:0},
  {q:"Referendum allows citizens to‚Ä¶",a:["Vote on laws passed by legislature","Rewrite federal laws","Control Supreme Court"],c:0},
  {q:"One problem under the 1803 Constitution was‚Ä¶",a:["Legislative dominance","Too many judges","No governor"],c:0},
  {q:"Both Ohio and U.S. Constitutions include‚Ä¶",a:["Separation of powers","Monarchy","Direct democracy only"],c:0},
  {q:"Debt limits were added in 1851 to‚Ä¶",a:["Protect taxpayers","Increase federal control","Expand war spending"],c:0},
  {q:"Attending a school board meeting demonstrates‚Ä¶",a:["Civic responsibility","Judicial review","Military authority"],c:0}
];

// =========================
// STATE
// =========================
let index=0;
let xp=0;
let level=1;
let streak=0;
let answered=false;
let name="";
let startTime=new Date();

// =========================
// DOM
// =========================
const qDiv=document.getElementById("question");
const cDiv=document.getElementById("choices");
const xpEl=document.getElementById("xp");
const lvlEl=document.getElementById("level");
const streakEl=document.getElementById("streak");
const badgeEl=document.getElementById("badge");
const cardEl=document.querySelector(".card");
const popLayer=document.getElementById("popLayer");

// =========================
// FX: shake, glow, popups, badge unlock
// =========================
function triggerShake(){
  cardEl.classList.remove("shake");
  void cardEl.offsetWidth; // restart animation
  cardEl.classList.add("shake");
}

function glowXP(){
  xpEl.classList.remove("xpGlow");
  void xpEl.offsetWidth;
  xpEl.classList.add("xpGlow");
}

function popup(text, anchorEl){
  const r = anchorEl.getBoundingClientRect();
  const p = document.createElement("div");
  p.className = "popup";
  p.textContent = text;
  p.style.left = (r.left + r.width/2) + "px";
  p.style.top = (r.top - 6) + "px";
  popLayer.appendChild(p);
  setTimeout(()=> p.remove(), 1000);
}

function badgeUnlock(newText){
  badgeEl.textContent = newText;
  badgeEl.classList.remove("badgeUnlock");
  void badgeEl.offsetWidth;
  badgeEl.classList.add("badgeUnlock");
  playSfx(SFX.sparkle);
}

// =========================
// RENDER
// =========================
function render(){
  const q=questions[index];
  qDiv.innerHTML=`<h3>${q.q}</h3>`;
  cDiv.innerHTML="";
  answered=false;

  q.a.forEach((choice,i)=>{
    const div=document.createElement("div");
    div.className="choice";
    div.textContent=choice;
    div.onclick=()=>check(i,div);
    cDiv.appendChild(div);
  });

  document.getElementById("progress").style.width=((index)/questions.length*100)+"%";
}

function updateStats(){
  xpEl.textContent=xp;
  lvlEl.textContent=level;
  streakEl.textContent=streak;
}

// =========================
// GAME LOGIC (with FX)
// =========================
function check(i,div){
  if(answered) return; // only first click counts

  const correct = (i===questions[index].c);
  if(correct){
    answered=true;
    div.classList.add("correct");
    playSfx(SFX.correct);

    // XP + streak multiplier
    const gain = 10 + (streak*2);
    xp += gain;
    streak++;

    glowXP();
    popup(`+${gain} XP`, xpEl);

    // Level up every 30 XP chunks (simple feel-good pacing)
    const newLevel = 1 + Math.floor(xp / 30);
    if(newLevel > level){
      level = newLevel;
      playSfx(SFX.level);
      badgeUnlock(level >= 6 ? "Ohio Icon" : (level >= 4 ? "Civic Champion" : "Reform Ranger"));
      // fireworks burst on level-up too
      fireworkBurst(window.innerWidth/2, window.innerHeight/2, 2);
    }

    updateStats();
  } else {
    answered=true;
    div.classList.add("wrong");
    playSfx(SFX.wrong);
    triggerShake();
    streak=0;
    updateStats();
    popup("STREAK BROKEN!", streakEl);
  }
}

function next(){
  index++;
  if(index>=questions.length){
    celebrate();
    return;
  }
  render();
}

// =========================
// CONFETTI + FIREWORKS (animated, continuous)
// =========================
const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");
let confetti = [];
let fireworks = [];
let animRunning = false;
let animStopAt = 0;

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);

function startCelebrationFX(durationMs=9000){
  resizeCanvas();
  animStopAt = performance.now() + durationMs;

  // build confetti field
  confetti = [];
  const count = 220;
  for(let i=0;i<count;i++){
    confetti.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height - canvas.height,
      size: Math.random()*7+4,
      vx: Math.random()*3-1.5,
      vy: Math.random()*2+2,
      rot: Math.random()*Math.PI*2,
      vr: Math.random()*0.18-0.09,
      color: `hsl(${Math.random()*360}, 100%, 55%)`,
      shape: Math.random()<0.5 ? "rect" : "ribbon"
    });
  }

  // initial big burst
  fireworkBurst(canvas.width/2, canvas.height*0.38, 4);

  if(!animRunning){
    animRunning = true;
    playSfx(SFX.boom); // synced start
    requestAnimationFrame(loopFX);
  }
}

function fireworkBurst(x,y,intensity=3){
  // create a burst of particles from (x,y)
  const burstCount = 45 + intensity*18;
  for(let i=0;i<burstCount;i++){
    const ang = Math.random()*Math.PI*2;
    const spd = (Math.random()*3.0 + 2.2) * intensity;
    fireworks.push({
      x,y,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      life: 70 + Math.random()*25,
      age: 0,
      size: 2 + Math.random()*2,
      color: `hsl(${Math.random()*360}, 100%, 60%)`
    });
  }
  playSfx(SFX.boom);
}

function loopFX(t){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // confetti
  const g = 0.06;
  confetti.forEach(p=>{
    p.vy += g;
    p.x += p.vx;
    p.y += p.vy;
    p.rot += p.vr;

    // wrap
    if(p.x < -20) p.x = canvas.width+20;
    if(p.x > canvas.width+20) p.x = -20;

    // respawn top
    if(p.y > canvas.height+30){
      p.y = -20;
      p.x = Math.random()*canvas.width;
      p.vy = Math.random()*2+2;
    }

    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(p.rot);
    ctx.fillStyle = p.color;

    if(p.shape === "rect"){
      ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
    } else {
      // ribbon-ish
      ctx.beginPath();
      ctx.moveTo(-p.size, 0);
      ctx.quadraticCurveTo(0, -p.size, p.size, 0);
      ctx.quadraticCurveTo(0, p.size, -p.size, 0);
      ctx.fill();
    }
    ctx.restore();
  });

  // fireworks particles
  fireworks = fireworks.filter(f => f.age < f.life);
  fireworks.forEach(f=>{
    f.age++;
    // gravity + drag
    f.vy += 0.04;
    f.vx *= 0.99;
    f.vy *= 0.99;
    f.x += f.vx;
    f.y += f.vy;

    const alpha = Math.max(0, 1 - (f.age / f.life));
    ctx.globalAlpha = alpha;
    ctx.fillStyle = f.color;
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.size, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  });

  // auto bursts for ‚Äúshow‚Äù
  if(Math.random() < 0.05){
    fireworkBurst(
      canvas.width*(0.25 + Math.random()*0.5),
      canvas.height*(0.18 + Math.random()*0.25),
      2
    );
  }

  if(t < animStopAt){
    requestAnimationFrame(loopFX);
  } else {
    // stop and clear
    ctx.clearRect(0,0,canvas.width,canvas.height);
    fireworks = [];
    confetti = [];
    animRunning = false;
  }
}

// =========================
// CELEBRATE
// =========================
function celebrate(){
  document.getElementById("progress").style.width="100%";
  startCelebrationFX(9500); // continuous falling confetti + fireworks
  badgeUnlock("STATEHOUSE LEGEND");

  const endTime = new Date();
  const runtimeSec = Math.max(0, Math.floor((endTime - startTime)/1000));
  const mm = String(Math.floor(runtimeSec/60)).padStart(2,"0");
  const ss = String(runtimeSec%60).padStart(2,"0");

  document.getElementById("ticket").innerHTML=`
    <div class="ticket">
      <h2>üèÜ Mastery Complete!</h2>
      XP Earned: ${xp}<br>
      Level: ${level}<br>
      Streak Best: (watch the next build üòâ)<br>
      Started: ${startTime}<br>
      Completed: ${endTime}<br>
      Runtime: ${mm}:${ss}
    </div>`;
}

// expose next() for your button
window.next = next;

// initial paint
render();
updateStats();
</script>
